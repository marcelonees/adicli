#!/bin/bash

# ==============================================================================
#
# Author: Marcelo Barreto Nees <marcelo.linux@gmail.com>
#
# ==============================================================================

#set -euxo pipefail

conf_header=/usr/share/adicli/base/header
conf_db_engine=/usr/share/adicli/base/db_engine

if [ ! -e $conf_header ] || [ ! -e $conf_db_engine ] ; then

  echo "$0: Error - Some framework files not found found."
  exit 1

fi

source $conf_header
source $conf_db_engine

# ==============================================================================
#
# Executa as queries, altera o template selecionado e retorna na tela
#
# ==============================================================================


# unix timestamp
timestamp=$(date +"%s")

# PID
export pid="${timestamp}.$$"

# Create temporary dir
mkdir -p /tmp/adicli/$pid

STRATEGY=${STRATEGY:-max}
AUTHOR=${AUTHOR:-Authors\'s Full Name <mail@domain>}
PARENT_CLASS=${PARENT_CLASS:-TPage}

# DATABASE
# CLASS
# ACTIVE_RECORD

##INIT_METHODS##
##FORM_SETUP##
##FORM_FIELDS##
##FILTER_FIELDS##
##LIST_COLUMNS##


# List tables
# ==============================================================================
function list() {
  echo "$show_tables"|$db_connector
}


# Generate Models, Forms, Lists etc..
# ==============================================================================
function generate() {
  echo "$db_command"|$db_connector|egrep -v '^( |$|CONSTRAINT)'|awk '{print $1,$2}'|while read field type; do
  
    type=$(echo $type|sed -e 's/(.*//g;')
  
    case $type in
      varchar)
        type_adianti="TEntry";
        ;;
    
      datetime|timestamp)
        type_adianti="TDate";
    	;;
    
      *)
        type_adianti="TEntry";
        ;;
    esac
  
    echo "        \$$field = new $type_adianti('$field');"                        			>> /tmp/adicli/$pid/FORM_FIELD_Objects.txt
    echo "        \$this->form->addFields( [ new TLabel('$field'), \$$field ] );" 			>> /tmp/adicli/$pid/FORM_FIELDS_Fields.txt
    echo "        \$column_$field = new TDataGridColumn('$field', '$field', 'left');"     		>> /tmp/adicli/$pid/LIST_COLUMNS.txt
    echo "        \$this->addFilterField('$field', '=', '$field'); // filterField, operator, formField" >> /tmp/adicli/$pid/FILTER_FIELDS.txt

    field=$(echo $field|sed -e 's/(.*//g; s/ .*//g')
    if [ "X$field" != "X" ] ; then
      echo "      parent::addAttribute('$field');"                                			>> /tmp/adicli/$pid/DINAMIC_CODE.txt
    fi
   
  done
}


# DINAMIC_CODE
# ==============================================================================
function DINAMIC_CODE() {
  cat /tmp/adicli/$pid/DINAMIC_CODE.txt
  echo "{NEWLINE}"
}


# FORM_FIELDS
# ==============================================================================
function FORM_FIELDS() {
  echo "{NEWLINE}"
  cat /tmp/adicli/$pid/FORM_FIELD_Objects.txt; 
  echo "{NEWLINE}"

  cat /tmp/adicli/$pid/FORM_FIELDS_Fields.txt; 
  echo "{NEWLINE}"
}


# LIST_COLUMNS
# ==============================================================================
function LIST_COLUMNS () {
  cat /tmp/adicli/$pid/FORM_FIELDS_Fields.txt;  echo "{NEWLINE}"
}


# FILTER_FIELDS
# ==============================================================================
function FILTER_FIELDS() {
  cat /tmp/adicli/$pid/FILTER_FIELDS.txt; echo "{NEWLINE}"
}


# List tables or Generate the Class
# ==============================================================================
if [ "X$option" = "Xlist" ] ; then

  list

else

  generate

  sed -e "
	s|{AUTHOR}|${AUTHOR}|g; 
  s|{TABLENAME}|${TABLENAME}|g; 
	s|{PRIMARYKEY}|${PRIMARYKEY}|g; 
	s|{PRIMARY_KEY}|${PRIMARYKEY}|g; 
	s|{STRATEGY}|$STRATEGY|g; 
	s|{DINAMIC_CODE}|$(echo `DINAMIC_CODE`)|g; 
	s|{CLASS}|$CLASS|g; 
	s|{ACTIVE_RECORD}|$ACTIVE_RECORD|g; 
	s|{DATABASE}|$DATABASE|g; 
	s|{PARENT_CLASS}|$PARENT_CLASS|g; 
	s|##INIT_METHODS##|$INIT_METHODS|g; 
	s|##FORM_SETUP##|$FORM_SETUP|g; 
	s|##FORM_FIELDS##|$(echo `FORM_FIELDS`)|g;
	s|##FILTER_FIELDS##|$(echo `FILTER_FIELDS`)|g;
	s|##LIST_COLUMNS##|$(echo `LIST_COLUMNS`)|g;
	s|{NEWLINE}|\n|g;
	s|<your name here>|${AUTHOR}|g;
  s|^[$]|\n        $|g
  s|; [$]|;\n        $|g
	s|parent::|\n    parent::|g;" $TEMPLATE


  # Clean files
  # ==============================================================================
  rm -f /tmp/adicli/$pid/*

fi